<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    烟柳画桥&晚来风急
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="miccall" />
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
</head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">烟柳画桥&晚来风急</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/Python/">Python</a></li><li><a class="category-link" href="/categories/ubuntu/">ubuntu</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        <li class="active">
	            <a href="#s1">归档</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="archive-link" href="/archives/2018/10/">十月 2018</a></li><li><a class="archive-link" href="/archives/2018/09/">九月 2018</a></li><li><a class="archive-link" href="/archives/2018/08/">八月 2018</a>
	                    </ul>
	        </li>
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="简历">
		                简历
		            </a>
		        </li>
		        
		        <li>
		            <a href="/group/" title="团队">
		                团队
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/FBIACID" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="500px" href="http://500px.com" target="_blank" rel="noopener">
                            <i class="icon fa fa-500px"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(/img/class3.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >网易云音乐评论</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h2 id="想爬取遍地情圣的网易云评论区，发现有一堆坑，还好依赖着前人勉强踩过坑获得了成功。用到的知识主要有-requestes-beautifulsoup-PyCryptodome等。"><a href="#想爬取遍地情圣的网易云评论区，发现有一堆坑，还好依赖着前人勉强踩过坑获得了成功。用到的知识主要有-requestes-beautifulsoup-PyCryptodome等。" class="headerlink" title="想爬取遍地情圣的网易云评论区，发现有一堆坑，还好依赖着前人勉强踩过坑获得了成功。用到的知识主要有:requestes,beautifulsoup,PyCryptodome等。"></a>想爬取遍地情圣的网易云评论区，发现有一堆坑，还好依赖着前人勉强踩过坑获得了成功。用到的知识主要有:requestes,beautifulsoup,PyCryptodome等。</h2><p>首先我们随机点开一首歌，用requests.get()获取其源码，结果我们发现好多信息是经过加密的，我们不能提取到有效的信息，贴个代码演示一下。</p>
<pre class=" language-bash"><code class="language-bash"><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/song?id=<span class="token variable">${x.id}</span>"</span><span class="token operator">></span><span class="token operator">&lt;</span>b title<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.name|escape}</span>{if alia} - (<span class="token variable">${alia|escape}</span>){/if}"</span><span class="token operator">></span><span class="token variable">${soil(x.name)}</span><span class="token operator">&lt;</span>/b<span class="token operator">></span><span class="token operator">&lt;</span>/a<span class="token operator">></span><span class="token punctuation">{</span>if alia<span class="token punctuation">}</span><span class="token operator">&lt;</span>span title<span class="token operator">=</span><span class="token string">"<span class="token variable">${alia|escape}</span>"</span> class<span class="token operator">=</span><span class="token string">"s-fc8"</span><span class="token operator">></span> - <span class="token punctuation">(</span><span class="token variable">${soil(alia)}</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token punctuation">{</span>/if<span class="token punctuation">}</span>
<span class="token punctuation">{</span>if x.mvid<span class="token operator">></span>0<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>span data-res-id<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.id}</span>"</span> data-res-action<span class="token operator">=</span><span class="token string">"mv"</span> title<span class="token operator">=</span><span class="token string">"播放mv"</span> class<span class="token operator">=</span><span class="token string">"mv"</span><span class="token operator">></span>MV<span class="token operator">&lt;</span>/span<span class="token operator">></span>
<span class="token punctuation">{</span>/if<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/span<span class="token operator">></span>
<span class="token operator">&lt;</span>/div<span class="token operator">></span>
<span class="token operator">&lt;</span>/div<span class="token operator">></span>
<span class="token operator">&lt;</span>div class<span class="token operator">=</span><span class="token string">"opt hshow"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>a class<span class="token operator">=</span><span class="token string">"u-icn u-icn-81 icn-add"</span> href<span class="token operator">=</span><span class="token string">"javascript:;"</span> title<span class="token operator">=</span><span class="token string">"添加到播放列表"</span> hidefocus<span class="token operator">=</span><span class="token string">"true"</span>
data-res-type<span class="token operator">=</span><span class="token string">"18"</span>
data-res-id<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.id}</span>"</span>
data-res-action<span class="token operator">=</span><span class="token string">"addto"</span>
<span class="token punctuation">{</span>if from<span class="token punctuation">}</span>data-res-from<span class="token operator">=</span><span class="token string">"<span class="token variable">${from.fid}</span>"</span> data-res-data<span class="token operator">=</span><span class="token string">"<span class="token variable">${from.fdata}</span>"</span><span class="token punctuation">{</span>/if<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&lt;</span>/a<span class="token operator">></span>
<span class="token operator">&lt;</span>span data-res-id<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.id}</span>"</span> data-res-type<span class="token operator">=</span><span class="token string">"18"</span> data-res-action<span class="token operator">=</span><span class="token string">"fav"</span> class<span class="token operator">=</span><span class="token string">"icn icn-fav"</span> title<span class="token operator">=</span><span class="token string">"收藏"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span>
<span class="token operator">&lt;</span>span data-res-id<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.id}</span>"</span> data-res-type<span class="token operator">=</span><span class="token string">"18"</span> data-res-action<span class="token operator">=</span><span class="token string">"share"</span> data-res-name<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.name}</span>"</span> data-res-author<span class="token operator">=</span><span class="token string">"{list x.artists as art}<span class="token variable">${art.name}</span>{if art_index&lt;x.artists.length-1}/{/if}{/list}"</span> <span class="token punctuation">{</span>if x.album<span class="token punctuation">}</span>data-res-pic<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.album.picUrl}</span>"</span><span class="token punctuation">{</span>/if<span class="token punctuation">}</span> class<span class="token operator">=</span><span class="token string">"icn icn-share"</span> title<span class="token operator">=</span><span class="token string">"分享"</span><span class="token operator">></span>分享<span class="token operator">&lt;</span>/span<span class="token operator">></span>
<span class="token operator">&lt;</span>span data-res-id<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.id}</span>"</span> data-res-type<span class="token operator">=</span><span class="token string">"18"</span> data-res-action<span class="token operator">=</span><span class="token string">"download"</span> class<span class="token operator">=</span><span class="token string">"icn icn-dl"</span> title<span class="token operator">=</span><span class="token string">"下载"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span>
<span class="token punctuation">{</span>if canDel<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>span data-res-id<span class="token operator">=</span><span class="token string">"<span class="token variable">${x.id}</span>"</span> data-res-type<span class="token operator">=</span><span class="token string">"18"</span> data-res-action<span class="token operator">=</span><span class="token string">"delete"</span> class<span class="token operator">=</span><span class="token string">"icn icn-del"</span> title<span class="token operator">=</span><span class="token string">"删除"</span><span class="token operator">></span>删除<span class="token operator">&lt;</span>/span<span class="token operator">></span>
<span class="token punctuation">{</span>/if<span class="token punctuation">}</span>
</code></pre>
<p>我们可以清楚的看到，我们需要提取的信息都被加密过。无法通过普通的办法获得我们想要的内容。<br>这时我们有两种思路：<br>1：使用selenium模拟浏览器的操作进行爬取。此方法我们不在这篇文章里讲述，想尝试的同学可以自己尝试。<br>2：鉴于该数据采取ajax，我们通过访问该网址获取其json字符串，直接完成其信息的采集。我们先按思路二进行下去。</p>
<p>首先在加载的一堆数据中排查得到我们需要的网址，如下：</p>
<pre class=" language-bash"><code class="language-bash">Request URL: https://music.163.com/weapi/v1/resource/comments/R_SO_4_531295576?csrf_token<span class="token operator">=</span>
Request Method: POST
Status Code: 200 OK
Remote Address: 127.0.0.1:1080
Referrer Policy: no-referrer-when-downgrade

Accept: */*
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh<span class="token punctuation">;</span>q<span class="token operator">=</span>0.9,en<span class="token punctuation">;</span>q<span class="token operator">=</span>0.8
Connection: keep-alive
Content-Length: 482
Content-Type: application/x-www-form-urlencoded
Cookie: 过长就不贴了。
Host: music.163.com
Origin: https://music.163.com
Referer: https://music.163.com/song?id<span class="token operator">=</span>531295576
User-Agent: Mozilla/5.0 <span class="token punctuation">(</span>Windows NT 10.0<span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/68.0.3440.106 Safari/537.36

Form Ddta:
    params: +0YydG970lh0RFa4CtT3YQEDyAB+YtGNJ+UbomdqEnY+TemTKHVbA3vJIX3NKgm07UOy+J2sKcSTM0smfpKbOA4Dm8TJcxbWZrVnjeVl/zE3z3PX21iD84D5Qt50oLrZv8Gug+LqS/y1JWBWiq6DZ0ZaZZEG8aYRYF2bwnPxX9v55DxZJmiubjteCc5lMs0S
    encSecKey: 762617ad7682a61121e378406d57ffd5aede0f3621e18d1584dab1eca7fdf3ca3d842d882111609a4ada5d3c24973450d1a8553ff96641f144a6de81688ae2c0a5798f8c23fa38e16139999692b6c91150b39c25c014ee6a2005e821485c3a6eab822db16f0397be0c54e43993cc34eae70c68739d19d0eb69e7ca86b16b585a

</code></pre>
<p>我们可以看出他是一个post请求，通过多次测试我们发现网址中那个数字会有变化。其他则保持不变，这串数字也很简单的可以发现就是这首歌在网易云的id，我们需要先爬取这个id之后才能进行下一步的操作(以热歌榜为例）。上代码说话。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> os
<span class="token keyword">import</span> re
<span class="token keyword">from</span> requests <span class="token keyword">import</span> ConnectionError
<span class="token keyword">from</span> requests <span class="token keyword">import</span> Timeout

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36"</span>
<span class="token punctuation">}</span>
<span class="token keyword">def</span> <span class="token function">get_index</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            response<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf8'</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span>text
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">except</span> ConnectionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Timeout <span class="token keyword">as</span> t<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">,</span>t<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">parse_url</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hot_list <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>r<span class="token string">'&lt;ul class="f-hide">&lt;li>&lt;a href="/song\?id=\d*?">.*&lt;/a>&lt;/li>&lt;/ul>'</span><span class="token punctuation">,</span>html<span class="token punctuation">)</span>
    hot_list <span class="token operator">=</span> hot_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    hot_music_id <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>r<span class="token string">'&lt;li>&lt;a href="/song\?id=(\d*?)">.*?&lt;/a>&lt;/li>'</span><span class="token punctuation">,</span>hot_list<span class="token punctuation">)</span>
    hot_music_name <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>r<span class="token string">'&lt;li>&lt;a href="/song\?id=\d*?">(.*?)&lt;/a>&lt;/li>'</span><span class="token punctuation">,</span>hot_list<span class="token punctuation">)</span>
    <span class="token keyword">return</span> hot_music_name<span class="token punctuation">,</span>hot_music_id

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"https://music.163.com/discover/toplist?id=3778678"</span>
    html <span class="token operator">=</span> get_index<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> html<span class="token punctuation">:</span>
        hot_music_name<span class="token punctuation">,</span>hot_music_id <span class="token operator">=</span> parse_url<span class="token punctuation">(</span>html<span class="token punctuation">)</span>

</code></pre>
<p>我用正则表达式提取出其id和名字，既然id到了那么下面应该很简单的吧。答案是这样吗？我们继续看：</p>
<hr>
<p>请求数据里有两个参数，params 和 encSecKey。如果我们只爬取该歌曲的第一页评论（或者说热评）的话，那么我们只要把这两个参数复制然后构造post请求，可以简单的做到这一点。</p>
<pre class=" language-python"><code class="language-python">
<span class="token keyword">def</span> <span class="token function">get_html</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token string">"dPn4YKam1ALLghjJadhyim4G05a1atAbF7ECvh5EGXihbxOV1i+TRS2oNZv+jR8H6nZ0DSoff6PQQ9mEnocZIv8D5ispn9aLDlta+vylq2wUnJQYLR0KkoQFYcXQ+VOvbmJyLK1acsZ/GuCkP+XFbr3h9WtEAXu3sxfn0DKFO06eNMufFrUHTmw7zyVFp64zYAHK4jIvkSTAkkVYqMu2IbwYG4coJ6wScE1DwKyRQlE="</span><span class="token punctuation">,</span>
        <span class="token string">"encSecKey"</span><span class="token punctuation">:</span> <span class="token string">"ca034db233499f555cd0009cf367f35093381ded33765fb6026c09c333a20b41d87bcd71504fc87159d55f6b2308343b0d443b8c68c575c1b6e6c37c98fdb571e4a0f61beb292ba4847840ba52f4d0f1c3169e3a2492c00a2cc7b4664a5eb63c6c06be9d90b9a0dc0c305aa8204820225ab5aeace9c2d4ee0dd628a5a022cdba"</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">"?csrf_token="</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ConnectionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span>args<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">save_parse</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'hotComments'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"Comments"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">"Comments"</span><span class="token punctuation">)</span>
    file_path <span class="token operator">=</span> <span class="token string">"{}/Hot.txt"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"Comments"</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> open<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> contents <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span> contents<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"***************************************************"</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
</code></pre>
<p>但是我们仅仅满足于热评吗？？？网易云的情圣们可能还隐藏在里面，那么我们继续采坑吧。<br>我们点击评论的下一页，通过开发者工具我们可以发现网址丝毫不变，其他也基本不变，那么我们的数据是怎么改变的呢，post传输的数据为罪魁祸首，那么这些post数据是怎么变化的呢，通过不断地寻找我们锁定了一个js脚本，我们发现这串数据来自于它，并且是加密过的（好难受），加密函数如下：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token operator">!</span>function<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> a<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var d, e, b <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>, c <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>d <span class="token operator">=</span> 0<span class="token punctuation">;</span> a <span class="token operator">></span> d<span class="token punctuation">;</span> d +<span class="token operator">=</span> 1<span class="token punctuation">)</span>
            e <span class="token operator">=</span> Math.random<span class="token punctuation">(</span><span class="token punctuation">)</span> * b.length,
            e <span class="token operator">=</span> Math.floor<span class="token punctuation">(</span>e<span class="token punctuation">)</span>,
            c +<span class="token operator">=</span> b.charAt<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> c
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> b<span class="token punctuation">(</span>a, b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var c <span class="token operator">=</span> CryptoJS.enc.Utf8.parse<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
          , d <span class="token operator">=</span> CryptoJS.enc.Utf8.parse<span class="token punctuation">(</span><span class="token string">"0102030405060708"</span><span class="token punctuation">)</span>
          , e <span class="token operator">=</span> CryptoJS.enc.Utf8.parse<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
          , f <span class="token operator">=</span> CryptoJS.AES.encrypt<span class="token punctuation">(</span>e, c, <span class="token punctuation">{</span>
            iv: d,
            mode: CryptoJS.mode.CBC
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> f.toString<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> c<span class="token punctuation">(</span>a, b, c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var d, e<span class="token punctuation">;</span>
        <span class="token keyword">return</span> setMaxDigits<span class="token punctuation">(</span>131<span class="token punctuation">)</span>,
        d <span class="token operator">=</span> new RSAKeyPair<span class="token punctuation">(</span>b,<span class="token string">""</span>,c<span class="token punctuation">)</span>,
        e <span class="token operator">=</span> encryptedString<span class="token punctuation">(</span>d, a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> d<span class="token punctuation">(</span>d, e, f, g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var h <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          , i <span class="token operator">=</span> a<span class="token punctuation">(</span>16<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> h.encText <span class="token operator">=</span> b<span class="token punctuation">(</span>d, g<span class="token punctuation">)</span>,
        h.encText <span class="token operator">=</span> b<span class="token punctuation">(</span>h.encText, i<span class="token punctuation">)</span>,
        h.encSecKey <span class="token operator">=</span> c<span class="token punctuation">(</span>i, e, f<span class="token punctuation">)</span>,
        h
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> e<span class="token punctuation">(</span>a, b, d, e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var f <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> f.encText <span class="token operator">=</span> c<span class="token punctuation">(</span>a + e, b, d<span class="token punctuation">)</span>,
        f
    <span class="token punctuation">}</span>
    window.asrsea <span class="token operator">=</span> d,
    window.ecnonasr <span class="token operator">=</span> e
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window.asrsea函数就是那个加密的罪魁祸首。也就是上面的d函数.
</code></pre>
<p>可以看出它采用CryptoJS加密,我们可以通过PyCryptodome(python3用户），如果你是python2的话，请安装这个pycrypto，pycrypto已经宣布永久停止维护了，所以请移步PyCryptodome吧，<a href="https://github.com/Legrandin/pycryptodome" title="PyCryptodome的github地址" target="_blank" rel="noopener">https://github.com/Legrandin/pycryptodome</a>。</p>
<hr>
<p>那么我们是如何发现这个函数的呢，Chrome开发者控制面板–source–点击 Event Listener Breakpoints–勾选XHR–点击重新加载–然后点击 Step over next function call的那个图标，就这样单步调试过去，就能找到那个函数。。然后我们打开Chrome的调试工具，把断点设在12973行我们可以发现上面的参数（格式化js语句点击下面出现的{}标志即可），既然找到了加密函数和相应的参数，那么我们开始用py模仿破解吧，经过多次翻页我们发现只有<br>{rid: “R_SO_4_574566207”, offset: “40”, total: “false”, limit: “20”, csrf_token: “”}<br>{rid: “R_SO_4_574566207”, offset: “60”, total: “false”, limit: “20”, csrf_token: “”}<br>可以看出只有offset参数是变化的，limit参数经过分析是控制每页评论数的，限制每页20条，其他则是固定不变的，结合上面的window.asrsea()函数，我们构造出加密字符串，完成post请求进而得到我们的评论数据。</p>
<p>回到我们的加密函数上，我们发现它经过AES加密和RSA加密。</p>
<pre class=" language-bash"><code class="language-bash"><span class="token keyword">function</span> d<span class="token punctuation">(</span>d, e, f, g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var h <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          , i <span class="token operator">=</span> a<span class="token punctuation">(</span>16<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> h.encText <span class="token operator">=</span> b<span class="token punctuation">(</span>d, g<span class="token punctuation">)</span>, <span class="token comment" spellcheck="true">#AES加密</span>
        h.encText <span class="token operator">=</span> b<span class="token punctuation">(</span>h.encText, i<span class="token punctuation">)</span>, <span class="token comment" spellcheck="true">#AES加密</span>
        h.encSecKey <span class="token operator">=</span> c<span class="token punctuation">(</span>i, e, f<span class="token punctuation">)</span>, <span class="token comment" spellcheck="true">#RSA加密</span>
        h
    <span class="token punctuation">}</span>
</code></pre>
<p>不懂这些加密函数什么意思，自学啊，还是先模仿吧。用到我们上面写到的PyCryptodome库，进行Crypto加密。我还是贴代码吧。。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#导入这些第三方库</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> math
<span class="token keyword">import</span> random
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> codecs
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
</code></pre>
<p>首先我们需要生成长度为16的随机字符串,这里我们仿照上面的javascript的实现,用Python生成16位长的随机字符串:</p>
<pre class=" language-bash"><code class="language-bash">def generate_random_strs<span class="token punctuation">(</span>length<span class="token punctuation">)</span>:
    string <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>
    <span class="token comment" spellcheck="true"># 控制次数参数i</span>
    i <span class="token operator">=</span> 0
    <span class="token comment" spellcheck="true"># 初始化随机字符串</span>
    random_strs  <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> length:
        e <span class="token operator">=</span> random.random<span class="token punctuation">(</span><span class="token punctuation">)</span> * len<span class="token punctuation">(</span>string<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 向下取整</span>
        e <span class="token operator">=</span> math.floor<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        random_strs <span class="token operator">=</span> random_strs + list<span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">[</span>e<span class="token punctuation">]</span>
        i <span class="token operator">=</span> i + 1
    <span class="token keyword">return</span> random_strs
</code></pre>
<p>AES加密的模式是AES.MODE_CBC,初始化向量iv=’0102030405060708′,具体的AES加密</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># AES加密</span>
def AESencrypt<span class="token punctuation">(</span>msg, key<span class="token punctuation">)</span>:
    <span class="token comment" spellcheck="true"># 如果不是16的倍数则进行填充(paddiing)</span>
    padding <span class="token operator">=</span> 16 - len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> % 16
    <span class="token comment" spellcheck="true"># 这里使用padding对应的单字符进行填充</span>
    msg <span class="token operator">=</span> msg + padding * chr<span class="token punctuation">(</span>padding<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 用来加密或者解密的初始向量(必须是16位)</span>
    iv <span class="token operator">=</span> <span class="token string">'0102030405060708'</span>.encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> key.encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> AES.new<span class="token punctuation">(</span>key, AES.MODE_CBC, iv<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 加密后得到的是bytes类型的数据</span>
    encryptedbytes <span class="token operator">=</span> cipher.encrypt<span class="token punctuation">(</span>msg.encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">))</span>
    <span class="token comment" spellcheck="true"># 使用Base64进行编码,返回byte字符串</span>
    encodestrs <span class="token operator">=</span> base64.b64encode<span class="token punctuation">(</span>encryptedbytes<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 对byte字符串按utf-8进行解码</span>
    enctext <span class="token operator">=</span> encodestrs.decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> enctext
</code></pre>
<p>RSA加密.首先我简单介绍一下RSA的加密过程.在RSA中,明文,密钥和密文都是数字.RSA的加密过程可以用下列的公式来表达,这个公式非常的重要,你只有理解了这个公式,才能用Python实现RSA加密</p>
<pre class=" language-bash"><code class="language-bash">密文    <span class="token operator">=</span>    明文^E mod  N           <span class="token punctuation">(</span>RSA加密<span class="token punctuation">)</span>
</code></pre>
<p>RSA的密文是对代表明文的数字的E次方求mod N 的结果, 通俗的讲就是将明文和自己做E次乘法,然后将其结果除以N 求余数,这个余数就是密文.</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># RSA加密</span>
<span class="token keyword">def</span> <span class="token function">RSAencrypt</span><span class="token punctuation">(</span>randomstrs<span class="token punctuation">,</span> key<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># 随机字符串逆序排列</span>
    string <span class="token operator">=</span> randomstrs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># 将随机字符串转换成byte类型数据</span>
    text <span class="token operator">=</span> bytes<span class="token punctuation">(</span>string<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    seckey <span class="token operator">=</span> int<span class="token punctuation">(</span>codecs<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>text<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">**</span>int<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">%</span> int<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> format<span class="token punctuation">(</span>seckey<span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
</code></pre>
<p>RSA加密后得到的字符串长为256,如果不够长则进行填充(不足部分在左侧添0).然后就是获取那两个参数。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_params</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># msg也可以写成msg = {"offset":"页面偏移量=(页数-1) *　20", "limit":"20"},offset和limit这两个参数必须有(js)</span>
    <span class="token comment" spellcheck="true"># limit最大值为100,当设为100时,获取第二页时,默认前一页是20个评论,也就是说第二页最新评论有80个,有20个是第一页显示的</span>
    <span class="token comment" spellcheck="true"># msg = '{"rid":"R_SO_4_1302938992","offset":"0","total":"True","limit":"100","csrf_token":""}'</span>
    <span class="token comment" spellcheck="true"># 偏移量</span>
    offset <span class="token operator">=</span> <span class="token punctuation">(</span>page<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span>
    <span class="token comment" spellcheck="true"># offset和limit是必选参数,其他参数是可选的,其他参数不影响data数据的生成</span>
    msg <span class="token operator">=</span> <span class="token string">'{"offset":'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">',"total":"True","limit":"20","csrf_token":""}'</span>
    key <span class="token operator">=</span> <span class="token string">'0CoJUm6Qyw8W8jud'</span>
    f <span class="token operator">=</span> <span class="token string">'00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7'</span>
    e <span class="token operator">=</span> <span class="token string">'010001'</span>
    enctext <span class="token operator">=</span> AESencrypt<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 生成长度为16的随机字符串</span>
    i <span class="token operator">=</span> generate_random_strs<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 两次AES加密之后得到params的值</span>
    encText <span class="token operator">=</span> AESencrypt<span class="token punctuation">(</span>enctext<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># RSA加密之后得到encSecKey的值</span>
    encSecKey <span class="token operator">=</span> RSAencrypt<span class="token punctuation">(</span>i<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    <span class="token keyword">return</span> encText<span class="token punctuation">,</span> encSecKey

</code></pre>
<p>下面构造表单不再赘述，所有参数都已得到。如果想用selenium的大佬，可以自己尝试一下。</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 valine -->
<div id="comment">
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#comment' ,
        notify: false,
        verify: false,
        app_id: '9tM16La8exNhYt7gi1M0jFUp-gzGzoHsz',
        app_key: 'FUvyJz3PFTdiABrpgBVd1dKN',
        placeholder: 'Please leave your footprints',
        pageSize: '10',
        avatar: '',
        avatar_cdn: 'https://gravatar.loli.net/avatar/'
    });
</script>
</div>
<style>
   #comment{
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2018总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
